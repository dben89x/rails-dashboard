!function(t){"use strict";t.widget("ui.jqcarousel",{options:{eccentricity:.99,focus:300,animationDuration:700,opacity:!0,resize:!0,angle:0,minOpacity:.2,minSizeRatio:.8,keyboardNavigation:!0,imageWidth:200,direction:"shortest",enlargeWidth:500,enlargeDuration:200,closeDuration:250,closeButtonSize:30,enlargeEnabled:!0,enlargedOffset:[0,0]},showFront:function(t,e,i){var s,n=void 0===e?this.options.animationDuration:e;i=i||this.options.direction,this._.enlarged||this._rotateImages(t,n,i,s)},enlarge:function(t){if(this.options.enlargeEnabled){var e,i=this._.images[t].image,s=i.clone(),n=i.parent();s[0].style.zIndex=200,s.appendTo(n),e=this._addCloseButton(s),this._.enlargedItems={image:s,button:e},this._enlarger(s,i[0],e[0],t),this._.enlarged=!0}},removeEnlarged:function(){if(this._.enlargedItems){var t=this,e=this._.enlargedItems.image,i=this._.enlargedItems.button;i.fadeOut(this.options.closeDuration),e.fadeOut(this.options.closeDuration,function(){e.remove(),i.remove(),t._.enlarged=!1})}},rotateRight:function(t){void 0===t&&(t=this.options.animationDuration),this._.activeAnimation||this.showFront((this._.current+1)%this._.images.length,t,"cw")},rotateLeft:function(t){void 0===t&&(t=this.options.animationDuration);var e=this._.current-1;0>e&&(e=this._.images.length-1),this._.activeAnimation||this.showFront(e,t,"ccw")},destroy:function(){this._removeEventListeners()},_rotateImages:function(t,e,i){var s=this._.images.length,n=this._.images[t],a=this._getDistance(n.angle,Math.PI/2,i),o=e/this._.stepDuration,h=a/o;for(this._.current=t,i=i||this.options.direction;s;)s-=1,this._.activeAnimation+=1,n=this._.images[s],this._moveImage(n,h,o,this._.images[s].angle+a,s)},_create:function(){this._initPrivateProperties(),this._handleElementId(),this._render(),this._sizeBackup(),this._performLayout(),this._removeEventHandlers(),this._addEventHandlers()},_initPrivateProperties:function(){this._={images:[],a:0,b:0,activeAnimation:0,current:0,stepDuration:25,sizeBackup:[],enlarged:!1,maxHeight:0,enlargedItems:null}},_handleElementId:function(){var e=t.data(document.body,"jqcarousels-count")||0;e+=1,t.data(document.body,"jqcarousels-count",e),this.element[0].id||(this.element[0].id="jqcarousel-"+e)},_render:function(){var e,i=this,s=t(this.element.children()),n=0;this.element[0].tabIndex=0,this.element.css("outline-width","0px"),this._calculateEllipse(),s.each(function(a){e={image:t(s[a])},i._.images.push(e),n+=1}),this.count=n},_calculateEllipse:function(){var t=this.options;this._.a=t.focus/t.eccentricity,this._.b=Math.sqrt(this._.a*this._.a-t.focus*t.focus)},_sizeBackup:function(){for(var t,e,i=this._.images,s=i.length,n=0;s;)s-=1,t=i[s].image.width(),e=i[s].image.height(),e>n&&(n=e),this._.sizeBackup[s]={width:t,ratio:e/t};this._.maxHeight=n},_performLayout:function(){this._performElementLayout(),this._performImagesLayout()},_performElementLayout:function(){this.element.width(2*this._.a+this.options.imageWidth),this.element.height(this._.maxHeight),this.element.css("overflow","visible"),this.element.css("position","relative")},_performImagesLayout:function(){var t,e,i=Math.PI/2,s=null,n=this._.images.length,a=this.options.imageWidth,o=2*Math.PI/n;for(this._.current=n-1;n;)n-=1,t=this._.sizeBackup[n].ratio,s=this._.images[n].image,this._.sizeBackup[n].width=a,this._.images[n].angle=i,s.width(a),s.height(a*t),e=this._setImagePosition(i)+";"+this._handlePerspective(n),this._setImageCssText(s[0],e),i+=o},_setImageCssText:function(t,e){var i="position: absolute;";t.style.cssText=i+e},_enlarger:function(e,i,s,n){var a=this.options.enlargeWidth,o=this.options.enlargeDuration,h=this.options.closeButtonSize,r=this._.sizeBackup[n].ratio,c=this.options.enlargedOffset;e.animate({width:a,height:a*r},{step:function(e,n){var a=c[0]+parseInt(i.style.left,10),o=c[1]+parseInt(i.style.top,10);"width"===n.prop?(e=e||t(this).width(),a-=(e-n.start)/2,this.style.left=a+"px",s.style.left=a-h/2+e+"px"):(e=e||t(this).height(),o-=(e-n.start)/2,this.style.top=o+"px",s.style.top=o-h/2+"px")}},o)},_addCloseButton:function(e){var i,s=this.options.closeButtonSize,n=t('<img src="./images/close.png" alt="close" />');return i=e.parent(),i.append(n),n.width(s),n.height(s),n.css({"z-index":201,position:"absolute",cursor:"pointer"}),n.bind("click",this._closeHandler()),e.bind("click",this._closeHandler()),n},_closeHandler:function(){var t=this;return function(){t.removeEnlarged()}},_removeEventHandlers:function(){for(var t=this._.images.length,e=this._.images;t;)t-=1,e[t].image.off();this.element.off("keydown.carousel."+this.element[0].id,this._addKeyboardHandler)},_addEventHandlers:function(){for(var t=this._.images,e=t.length,i=null;e;)e-=1,i=t[e].image,this._addMouseHandlers(e);this.element.on("keydown.carousel."+this.element[0].id,{self:this},this._addKeyboardHandler)},_addMouseHandlers:function(t){var e=this,i=this._.images[t];i.image.on("click",function(){if(!e._.activeAnimation){var s=e._getDistance(i.angle,Math.PI/2,e.options.direction);0!==s?e.showFront(t):e.enlarge(t)}})},_addKeyboardHandler:function(t){var e=t.data.self;e.options.keyboardNavigation&&(39===t.keyCode?e.rotateLeft():37===t.keyCode&&e.rotateRight())},_moveImage:function(t,e,i,s,n){var a,o=this;i>0?(t.angle+=e,setTimeout(function(){o._moveImage(t,e,i-1,s,n)},this._.stepDuration)):this._finishImageMovement(s,t),a=this._handlePerspective(n),a+=";"+this._setImagePosition(t.angle),this._setImageCssText(t.image[0],a)},_finishImageMovement:function(t,e){if(0>t)for(;0>t;)t+=2*Math.PI;e.angle=t,e.angle%=2*Math.PI,this._.activeAnimation-=1},_setImagePosition:function(t){var e=this._.a*Math.cos(t)+this._.a,i=this._.b*Math.sin(t)+this._.b,s=e,n=i,a=this.options.angle;return a&&(s=Math.cos(a)*e-Math.sin(a)*i,n=Math.sin(a)*e+Math.cos(a)*i),s+="px",n+="px","left:"+s+";top:"+n},_handlePerspective:function(t){var e,i=this._.images[t],s=Math.round(100*Math.sin(i.angle))+100,n=s/200;return e=this._handleOpacity(n+this.options.minOpacity),e+=";z-index:"+s,e+=";"+this._handleSize(t,n+this.options.minSizeRatio)},_handleOpacity:function(t){return this.options.opacity?(t>1?t=1:0>t&&(t=0),"opacity:"+t):""},_handleSize:function(t,e){var i,s=this._.sizeBackup[t].width,n=s*this._.sizeBackup[t].ratio;return this.options.resize&&(e=e>1?1:e,i=this._.sizeBackup[t],s=i.width*e,n=s*i.ratio),"width:"+s+"px;height:"+n+"px"},_getDistance:function(t,e,i){if(t===e)return 0;switch(i=i||this.options.direction){case"cw":return this._getCWDistance(t,e);case"ccw":return this._getCCWDistance(t,e);case"shortest":var s=Math.abs(this._getCCWDistance(t,e)),n=this._getCWDistance(t,e);return s>n?n:-s}return 0},_getCWDistance:function(t,e){var i,s=0;return i=Math.abs(t-e)%(2*Math.PI),s=Math.cos(t)<0?Math.max(2*Math.PI-i,i):Math.min(2*Math.PI-i,i)},_getCCWDistance:function(t,e){var i,s=0;return i=Math.abs(t-e)%(2*Math.PI),s=Math.cos(t)>0?Math.max(2*Math.PI-i,i):Math.min(2*Math.PI-i,i),-s}})}(jQuery);